--==================================================
-- TANPHU GLOBAL PETS FINDER (UI + API, 1M‚Äì50M)
--  ‚Ä¢ UI 10M- / 10M+ d√πng chung cho m·ªçi ng∆∞·ªùi
--  ‚Ä¢ ƒê·ªçc list t·ª´ Python API (/farms)
--  ‚Ä¢ Scanner local:
--      - 1M‚Äì50M  ‚Üí Webhook_1 + API (/add_farm)
--      - >50M    ‚Üí Webhook_2 (kh√¥ng v√†o UI n√†y)
--  ‚Ä¢ KH√îNG d√πng Bot Token trong Lua (ch·ªâ webhook)
--  ‚Ä¢ T√çCH H·ª¢P ULTRA DESYNC (R / /desync / n√∫t Desync)
--==================================================

repeat task.wait() until game:IsLoaded()

if _G.TanPhu_GlobalPetsFinder_Loaded then
    warn("[GlobalPetsFinder] Script ƒë√£ ch·∫°y, kh√¥ng ch·∫°y l·∫°i.")
    return
end
_G.TanPhu_GlobalPetsFinder_Loaded = true

--========================
-- üîß CONFIG
--========================
local API_BASE       = "https://reparative-mira-dominatingly.ngrok-free.dev"
local USE_API        = true
local ENABLE_SCANNER = true
local FETCH_INTERVAL = 6

local WEBHOOK_HIGH   = "https://discordapp.com/api/webhooks/1411329828904374293/elK3umTJvdL6h4ml-EHg9DbM1wCdQJFpOsNWEEB79T0P1hRstSgd_ep75KIp-aHdIdoK" -- 1M‚Äì50M
local WEBHOOK_OVER50 = "https://discordapp.com/api/webhooks/1410314122670903491/KD8clDHrbOMKlArHAoEyMXTqQGD6AAN7ftlYvdkFEOj5a9_VEGA9yqAhoH2XPK77TITb" -- >50M

--========================
-- SERVICES
--========================
local Players         = game:GetService("Players")
local HttpService     = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local UIS             = game:GetService("UserInputService")
local LocalPlayer     = Players.LocalPlayer

--========================
-- HTTP (exploit request)
--========================
local http_request_impl =
    (typeof(syn) == "table" and typeof(syn.request) == "function" and syn.request)
    or (typeof(http_request) == "function" and http_request)
    or (typeof(request) == "function" and request)
    or (typeof(http) == "table" and typeof(http.request) == "function" and http.request)

if not http_request_impl then
    warn("[GlobalPetsFinder] ‚ùå Kh√¥ng t√¨m th·∫•y http_request_impl (syn/request/http). API/Webhook s·∫Ω kh√¥ng d√πng ƒë∆∞·ª£c.")
end

local function safeRequest(opts)
    if not http_request_impl then
        return nil, "no_http"
    end
    local ok, res = pcall(http_request_impl, opts)
    if not ok then
        return nil, res
    end
    return res, nil
end

local function sendWebhook(url, payload)
    if not url or url == "" then return end
    local body = HttpService:JSONEncode(payload)
    local res, err = safeRequest({
        Url = url,
        Method = "POST",
        Headers = {
            ["Content-Type"] = "application/json"
        },
        Body = body
    })
    if not res then
        warn("[GlobalPetsFinder] Webhook error:", err)
    elseif res.StatusCode and res.StatusCode >= 300 then
        warn("[GlobalPetsFinder] Webhook HTTP", res.StatusCode, res.Body or "")
    end
end

--========================
-- üéØ TARGET LIST (BRAINROT)
--========================
local targets = {
    'Chipso and Queso','La Casa Boo','Tang Tang Keletang','Headless Horseman',
    'Strawberry Elephant','Chicleteira Bicicleteira','Los Chicleteiras',
    'La Grande Combinasion','Nuclearo Dinossauro','Esok Sekolah','Ketupat Kepat',
    'Money Money Puggy','Tictac Sahur','Ketchuru and Musturu','Garama and Madundung',
    'Spaghetti Tualetti','Dragon Cannelloni','67','Mariachi Corazoni','Tacorita Bicicleta',
    'La Extinct Grande','Las Sis',
    'Celularcini Viciosini','Los Bros','Tralaledon','Los Tacoritas','Los Primos',
    'Chillin Chili','Los Combinasionas','Los Hotspotsitos','La Supreme Combinasion',
    'Los 67','La Secret Combinasion','Burguro And Fryuro','La Spooky Grande','Los Mobilis',
    'Eviledon','Spooky and Pumpky','Mieteteira Bicicleteira','Los Spooky Combinasionas','Meowl',
    'Los Matteos','Bisonte Guppitere','La Vacca Saturno Saturnita','Los Spiderinis','Los Tralaleritos',
    'Yess My Examine','Las Tralaleritas','Job Job Job Sahur','Las Vaquitas Saturnitas','1x1x1x1','Guest 666',
    'Captiano Moby','La Taco Combinasion','Los Puggies','Los Spaghettis','Fragrama and Chocrama','Orcaledon','Swag Soda'
}

local targetsLower = {}
for _, t in ipairs(targets) do
    table.insert(targetsLower, string.lower(t))
end

local function detectBrainrotName(model)
    if not model then return nil end

    -- t√™n model
    local nameLower = string.lower(model.Name or "")
    for i, tLower in ipairs(targetsLower) do
        if string.find(nameLower, tLower, 1, true) then
            return targets[i]
        end
    end

    -- label con
    for _, d in ipairs(model:GetDescendants()) do
        if d:IsA("TextLabel") or d:IsA("TextButton") then
            local txt = d.Text
            if txt and txt ~= "" then
                local l = string.lower(txt)
                for i, tLower in ipairs(targetsLower) do
                    if string.find(l, tLower, 1, true) then
                        return targets[i]
                    end
                end
            end
        end
    end

    return nil
end

--========================
-- üí∞ PARSE MPS
--========================
local function parseMps(raw)
    if raw == nil then return 0 end
    if typeof(raw) == "number" then
        return raw
    end

    local s = tostring(raw):gsub(",", ""):gsub("%s+", ""):upper()
    local num = tonumber(s:match("([%d%.]+)")) or 0

    if s:find("B") then
        return num * 1e9
    elseif s:find("M") then
        return num * 1e6
    elseif s:find("K") then
        return num * 1e3
    else
        return num
    end
end

local function formatMpsShort(v)
    v = tonumber(v) or 0
    if v >= 1e9 then
        return string.format("%.2fB", v/1e9)
    elseif v >= 1e6 then
        return string.format("%.2fM", v/1e6)
    elseif v >= 1e3 then
        return string.format("%.2fK", v/1e3)
    else
        return tostring(math.floor(v))
    end
end

-- NG∆Ø·ª†NG
local MIN_MPS   = 1_000_000
local TEN_MPS   = 10_000_000
local SPLIT_MPS = 50_000_000

--========================
-- üåê API HELPERS
--========================
local function apiAddFarm(petName, mps, jobId, placeId)
    if not USE_API or not API_BASE or API_BASE == "" then return end

    local payload = {
        pet_name     = petName,
        farm_display = formatMpsShort(mps) .. "/s",
        job_id       = jobId,
        place_id     = placeId,
        mps          = mps,
    }

    local body = HttpService:JSONEncode(payload)
    local res, err = safeRequest({
        Url = API_BASE .. "/add_farm",
        Method = "POST",
        Headers = {
            ["Content-Type"] = "application/json"
        },
        Body = body
    })

    if not res then
        warn("[GlobalPetsFinder] API add_farm error:", err)
        return
    end
    if res.StatusCode and res.StatusCode >= 300 then
        warn("[GlobalPetsFinder] API add_farm HTTP", res.StatusCode, res.Body or "")
    end
end

local function apiFetchFarms()
    if not USE_API or not API_BASE or API_BASE == "" then
        return {}
    end

    local res, err = safeRequest({
        Url = API_BASE .. "/farms?limit=80",
        Method = "GET",
        Headers = {}
    })

    if not res then
        warn("[GlobalPetsFinder] API farms HTTP error:", err)
        return {}
    end
    if res.StatusCode ~= 200 then
        warn("[GlobalPetsFinder] API farms HTTP", res.StatusCode, res.Body or "")
        return {}
    end

    local ok, data = pcall(function()
        return HttpService:JSONDecode(res.Body)
    end)
    if not ok or type(data) ~= "table" or not data.ok or type(data.farms) ~= "table" then
        warn("[GlobalPetsFinder] API farms decode error")
        return {}
    end

    local result = {}
    for _, farm in ipairs(data.farms) do
        local name  = farm.pet_name or farm.name
        local jobId = farm.job_id   or farm.jobId
        local mps   = parseMps(farm.mps or farm.farm_display or "")

        if name and jobId and mps >= MIN_MPS and mps <= SPLIT_MPS then
            table.insert(result, {
                name  = name,
                mps   = mps,
                jobId = jobId,
            })
        end
    end

    return result
end

--========================
-- UI + AUTO JOIN
--========================
local autoJoinEnabled   = false
local autoJoinedJobs    = {}
local currentTab        = "HIGH"   -- "LOW" or "HIGH"
local desyncToggleOn    = false    -- tr·∫°ng th√°i n√∫t Desync (UI)
local ScreenGui, MainFrame
local ScrollingLow, ScrollingHigh
local BtnDesync

local function AddPetItem(scrolling, petName, mps, jobId)
    if not scrolling then return end

    local Item = Instance.new("Frame")
    Item.Name = "PetItem"
    Item.Size = UDim2.new(1, -8, 0, 42)
    Item.BackgroundColor3 = Color3.fromRGB(32,40,55)
    Item.BorderSizePixel = 0
    Item.Parent = scrolling

    local ItemCorner = Instance.new("UICorner")
    ItemCorner.CornerRadius = UDim.new(0, 8)
    ItemCorner.Parent = Item

    local ItemStroke = Instance.new("UIStroke")
    ItemStroke.Thickness = 1
    ItemStroke.Color = Color3.fromRGB(0,200,255)
    ItemStroke.Transparency = 0.15
    ItemStroke.Parent = Item

    local Name = Instance.new("TextLabel")
    Name.Size = UDim2.new(0.55, 0, 1, 0)
    Name.Position = UDim2.new(0, 10, 0, 0)
    Name.BackgroundTransparency = 1
    Name.Text = tostring(petName)
    Name.Font = Enum.Font.GothamMedium
    Name.TextColor3 = Color3.fromRGB(255,255,255)
    Name.TextSize = 14
    Name.TextXAlignment = Enum.TextXAlignment.Left
    Name.Parent = Item

    local Farm = Instance.new("TextLabel")
    Farm.Size = UDim2.new(0.2, 0, 1, 0)
    Farm.Position = UDim2.new(0.55, 0, 0, 0)
    Farm.BackgroundTransparency = 1
    Farm.Text = formatMpsShort(mps) .. "/s"
    Farm.TextColor3 = Color3.fromRGB(180,180,190)
    Farm.Font = Enum.Font.Gotham
    Farm.TextSize = 13
    Farm.Parent = Item

    local Join = Instance.new("TextButton")
    Join.Size = UDim2.new(0.2, -10, 0, 30)
    Join.Position = UDim2.new(0.8, 0, 0.5, -15)
    Join.BackgroundColor3 = Color3.fromRGB(0,140,255)
    Join.Text = "Join"
    Join.TextColor3 = Color3.fromRGB(255,255,255)
    Join.Font = Enum.Font.GothamBold
    Join.TextSize = 14
    Join.AutoButtonColor = true
    Join.Parent = Item

    local JoinCorner = Instance.new("UICorner")
    JoinCorner.CornerRadius = UDim.new(0, 8)
    JoinCorner.Parent = Join

    Join.MouseButton1Click:Connect(function()
        TeleportService:TeleportToPlaceInstance(game.PlaceId, jobId, LocalPlayer)
    end)
end

local function clearScrolling(frame)
    if not frame then return end
    for _, c in ipairs(frame:GetChildren()) do
        if c:IsA("Frame") and c.Name == "PetItem" then
            c:Destroy()
        end
    end
end

--========================
-- DESYNC CORE (logic)
--========================
local RunService = game:GetService("RunService")
local desyncRunning = false

-- C·∫•u h√¨nh SOFT DESYNC cho mobile y·∫øu (√≠t gi·∫≠t, v·∫´n b·∫©n net)
local DESYNC_CFG = {
    PosLoopsFar   = 6,     -- quƒÉng xa √≠t l·∫ßn h∆°n
    PosLoopsNear  = 18,    -- jitter √≠t v√≤ng h∆°n
    FarRange      = 2500,  -- t·∫ßm quƒÉng xa (gi·∫£m m·∫°nh)
    NearRange     = 60,    -- jitter quanh pivot nh·ªè h∆°n
    VelLoops      = 18,    -- √≠t v√≤ng spam velocity
    VelPower      = 22000, -- l·ª±c velocity gi·∫£m nhi·ªÅu
    RotLoops      = 30,    -- xoay √≠t ‚Üí m√†n ƒë·ª° quay ƒëi√™n
    HeartbeatTime = 1.6,   -- gi·ªØ velocity cao 1.6s
    KillDelay     = 1.8,   -- kill s·ªõm h∆°n ch√∫t
}

local function setupSafeFFlags()
    if not setfflag then
        warn("‚ö†Ô∏è  setfflag not available - continuing without flags")
        return false
    end
    
    local flags = {
        {"GameNetPVHeaderRotationalVelocityZeroCutoffExponent", "-5000"},
        {"GameNetPVHeaderLinearVelocityZeroCutoffExponent", "-5000"},
        {"MaxAcceptableUpdateDelay", "1"},
        {"InterpolationFrameVelocityThresholdMillionth", "5"},
        {"InterpolationFrameRotVelocityThresholdMillionth", "5"},
        {"InterpolationFramePositionThresholdMillionth", "5"},
        {"CheckPVCachedVelThresholdPercent", "10"},
        {"CheckPVCachedRotVelThresholdPercent", "10"},
        {"GameNetDontSendRedundantNumTimes", "1"},
        {"GameNetDontSendRedundantDeltaPositionMillionth", "1"},
        {"ServerMaxBandwith", "52"},
        {"PhysicsSenderMaxBandwidthBps", "20000"},
        {"S2PhysicsSenderRate", "15000"},
        {"MaxTimestepMultiplierAcceleration", "100"},
        {"WorldStepMax", "30"},
        {"AngularVelociryLimit", "360"},
        {"LargeReplicatorWrite5", "true"},
        {"LargeReplicatorRead5", "true"},
        {"NextGenReplicatorEnabledWrite4", "true"},
        {"DisableDPIScale", "true"},
    }

    for _, flag_data in ipairs(flags) do
        pcall(function()
            setfflag(flag_data[1], flag_data[2])
        end)
    end
    return true
end

local function createDesync(character)
    if desyncRunning then
        warn("[DESYNC] ƒêang ch·∫°y, ch·ªù respawn xong ƒë√£.")
        return
    end

    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not rootPart or humanoid.Health <= 0 then
        warn("‚ùå Character not ready")
        return
    end

    desyncRunning = true
    print("\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    print("üöÄ [DESYNC] STARTING! (SOFT MOBILE)")
    print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")

    local active   = true
    local originCF = rootPart.CFrame

    -- Layer 1: Position (2 pha, t·∫ßm nh·ªè h∆°n ‚Üí √≠t gi·∫≠t h∆°n)
    task.spawn(function()
        -- Pha 1: quƒÉng xa v√†i l·∫ßn ƒë·ªÉ c·∫Øt sync
        for i = 1, DESYNC_CFG.PosLoopsFar do
            if not active or not rootPart.Parent then break end
            local r = DESYNC_CFG.FarRange
            rootPart.CFrame = CFrame.new(
                originCF.X + math.random(-r, r),
                originCF.Y + math.random(-r, r),
                originCF.Z + math.random(-r, r)
            )
            task.wait(0.02)
        end

        -- Pha 2: jitter quanh pivot tr√™n cao (camera ƒë·ª° ƒëi√™n v√¨ range nh·ªè)
        local pivot = originCF * CFrame.new(0, 1200, 0)
        for i = 1, DESYNC_CFG.PosLoopsNear do
            if not active or not rootPart.Parent then break end
            local r = DESYNC_CFG.NearRange
            local off = Vector3.new(
                math.random(-r, r),
                math.random(-r, r),
                math.random(-r, r)
            )
            rootPart.CFrame = pivot + off
            task.wait(0.02)
        end
    end)

    -- Layer 2: Velocity (nh·∫π h∆°n r·∫•t nhi·ªÅu)
    task.spawn(function()
        for i = 1, DESYNC_CFG.VelLoops do
            if not active or not rootPart.Parent then break end
            local v = DESYNC_CFG.VelPower
            rootPart.AssemblyLinearVelocity = Vector3.new(
                math.random(-v, v),
                math.random(-v, v),
                math.random(-v, v)
            )
            task.wait(0.02)
        end
    end)

    -- Layer 3: Rotation (√≠t v√≤ng ƒë·ªÉ ƒë·ª° ch√≥ng m·∫∑t)
    task.spawn(function()
        for i = 1, DESYNC_CFG.RotLoops do
            if not active or not rootPart.Parent then break end
            rootPart.CFrame = rootPart.CFrame * CFrame.Angles(
                math.rad(math.random(-90,90)),
                math.rad(math.random(-180,180)),
                math.rad(math.random(-90,90))
            )
            task.wait(0.02)
        end
    end)

    -- Layer 4: Invisible
    task.spawn(function()
        task.wait(0.25)
        for _, v in pairs(character:GetDescendants()) do
            if v:IsA("BasePart") then
                v.Transparency = 1
                v.CanCollide = false
            elseif v:IsA("Decal") or v:IsA("Face") then
                v.Transparency = 1
            end
        end
    end)

    -- Layer 5: Heartbeat gi·ªØ velocity cao
    task.spawn(function()
        local conn
        conn = RunService.Heartbeat:Connect(function()
            if not active or not rootPart.Parent then return end
            local v = DESYNC_CFG.VelPower
            rootPart.AssemblyLinearVelocity = Vector3.new(v, v, v)
        end)
        task.wait(DESYNC_CFG.HeartbeatTime)
        if conn then conn:Disconnect() end
        active = false
    end)

    -- Kill + respawn (gi·ªØ logic c≈©, ch·ªâ ƒë·ªïi th·ªùi gian)
    task.spawn(function()
        task.wait(DESYNC_CFG.KillDelay)
        if humanoid and humanoid.Parent then
            humanoid.Health = 0
        end
        task.wait(1.5)

        if not Players.LocalPlayer.Character
        or Players.LocalPlayer.Character == character then
            pcall(function()
                for _, tool in pairs(Players.LocalPlayer.Backpack:GetChildren()) do
                    tool:Destroy()
                end
            end)
            pcall(function()
                if humanoid and humanoid.Parent then
                    humanoid:ChangeState(Enum.HumanoidStateType.Dead)
                end
            end)
            task.wait(0.3)
            pcall(function()
                if Players.LocalPlayer.Character == character then
                    character:Destroy()
                end
            end)
        end

        desyncRunning = false
        print("‚úÖ [DESYNC] Done, respawn initiated.")
        print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n")
    end)
end

local function triggerDesync()
    local char = Players.LocalPlayer.Character
    if not char then
        warn("‚ùå No character")
        return
    end
    createDesync(char)
end

--========================
-- UI CREATE
--========================
local function createUI()
    ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "TanPhuGlobalPetsFinder"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

    -- N√∫t Hide UI b√™n tr√°i m√†n h√¨nh
    local HideButton = Instance.new("TextButton")
    HideButton.Name = "TanPhuHideUI"
    HideButton.Size = UDim2.new(0, 90, 0, 30)
    HideButton.Position = UDim2.new(0, 60, 0, 60)
    HideButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    HideButton.BackgroundTransparency = 0.2
    HideButton.Text = "Hide UI"
    HideButton.TextColor3 = Color3.fromRGB(255,255,255)
    HideButton.Font = Enum.Font.GothamBold
    HideButton.TextSize = 14
    HideButton.Parent = ScreenGui

    local HideCorner = Instance.new("UICorner")
    HideCorner.CornerRadius = UDim.new(0, 8)
    HideCorner.Parent = HideButton

    MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 450, 0, 380)
    MainFrame.Position = UDim2.new(0.5, -225, 0.5, -190)
    MainFrame.BackgroundColor3 = Color3.fromRGB(15,15,18)
    MainFrame.BorderSizePixel = 0
    MainFrame.Active = true
    MainFrame.Draggable = true
    MainFrame.Parent = ScreenGui

    local FrameCorner = Instance.new("UICorner")
    FrameCorner.CornerRadius = UDim.new(0, 10)
    FrameCorner.Parent = MainFrame

    local FrameStroke = Instance.new("UIStroke")
    FrameStroke.Thickness = 1.5
    FrameStroke.Color = Color3.fromRGB(0, 180, 255)
    FrameStroke.Transparency = 0.4
    FrameStroke.Parent = MainFrame

    HideButton.MouseButton1Click:Connect(function()
        MainFrame.Visible = not MainFrame.Visible
        if MainFrame.Visible then
            clearScrolling(ScrollingLow)
            clearScrolling(ScrollingHigh)
        end
    end)

    local TitleBar = Instance.new("Frame")
    TitleBar.Size = UDim2.new(1, 0, 0, 42)
    TitleBar.BackgroundColor3 = Color3.fromRGB(20,20,26)
    TitleBar.BorderSizePixel = 0
    TitleBar.Parent = MainFrame

    local TitleCorner = Instance.new("UICorner")
    TitleCorner.CornerRadius = UDim.new(0, 10)
    TitleCorner.Parent = TitleBar

    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(1, -20, 1, 0)
    Title.Position = UDim2.new(0, 10, 0, 0)
    Title.BackgroundTransparency = 1
    Title.Text = "TanPhu freehub | Pets Finder (1M‚Äì50M+ via API)"
    Title.TextColor3 = Color3.fromRGB(0, 255, 255)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 18
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Parent = TitleBar

    local TitleGradient = Instance.new("UIGradient")
    TitleGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 255, 200)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 180, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(180, 0, 255)),
    })
    TitleGradient.Parent = Title

    local CtrlHint = Instance.new("TextLabel")
    CtrlHint.Size = UDim2.new(0, 80, 0, 16)
    CtrlHint.Position = UDim2.new(1, -90, 0, 4)
    CtrlHint.BackgroundTransparency = 1
    CtrlHint.Text = "[Ctrl] Hide"
    CtrlHint.Font = Enum.Font.Gotham
    CtrlHint.TextSize = 11
    CtrlHint.TextColor3 = Color3.fromRGB(150,150,160)
    CtrlHint.TextXAlignment = Enum.TextXAlignment.Right
    CtrlHint.Parent = TitleBar

    local OnlineLabel = Instance.new("TextLabel")
    OnlineLabel.Size = UDim2.new(0, 80, 0, 16)
    OnlineLabel.Position = UDim2.new(1, -90, 1, -18)
    OnlineLabel.BackgroundTransparency = 1
    OnlineLabel.Text = "Online üü¢"
    OnlineLabel.Font = Enum.Font.GothamSemibold
    OnlineLabel.TextSize = 12
    OnlineLabel.TextColor3 = Color3.fromRGB(120,255,120)
    OnlineLabel.TextXAlignment = Enum.TextXAlignment.Right
    OnlineLabel.Parent = TitleBar

    local ControlBar = Instance.new("Frame")
    ControlBar.Size = UDim2.new(1, -20, 0, 32)
    ControlBar.Position = UDim2.new(0, 10, 0, 48)
    ControlBar.BackgroundColor3 = Color3.fromRGB(19,19,24)
    ControlBar.BorderSizePixel = 0
    ControlBar.Parent = MainFrame

    local ControlCorner = Instance.new("UICorner")
    ControlCorner.CornerRadius = UDim.new(0, 8)
    ControlCorner.Parent = ControlBar

    local AutoJoinLabel = Instance.new("TextLabel")
    AutoJoinLabel.Size = UDim2.new(0, 120, 1, 0)
    AutoJoinLabel.Position = UDim2.new(0, 10, 0, 0)
    AutoJoinLabel.BackgroundTransparency = 1
    AutoJoinLabel.Text = "Auto Join:"
    AutoJoinLabel.Font = Enum.Font.GothamSemibold
    AutoJoinLabel.TextSize = 14
    AutoJoinLabel.TextColor3 = Color3.fromRGB(220,220,230)
    AutoJoinLabel.TextXAlignment = Enum.TextXAlignment.Left
    AutoJoinLabel.Parent = ControlBar

    local AutoJoinButton = Instance.new("TextButton")
    AutoJoinButton.Size = UDim2.new(0, 90, 0, 26)
    AutoJoinButton.Position = UDim2.new(0, 110, 0.5, -13)
    AutoJoinButton.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
    AutoJoinButton.BorderSizePixel = 0
    AutoJoinButton.Text = "OFF"
    AutoJoinButton.Font = Enum.Font.GothamBold
    AutoJoinButton.TextSize = 14
    AutoJoinButton.TextColor3 = Color3.fromRGB(255,255,255)
    AutoJoinButton.Parent = ControlBar

    local AutoJoinCorner = Instance.new("UICorner")
    AutoJoinCorner.CornerRadius = UDim.new(0, 8)
    AutoJoinCorner.Parent = AutoJoinButton

    local AutoJoinStroke = Instance.new("UIStroke")
    AutoJoinStroke.Thickness = 1.4
    AutoJoinStroke.Color = Color3.fromRGB(200, 60, 60)
    AutoJoinStroke.Transparency = 0.2
    AutoJoinStroke.Parent = AutoJoinButton

    local function updateAutoJoinVisual()
        if autoJoinEnabled then
            AutoJoinButton.BackgroundColor3 = Color3.fromRGB(0, 170, 90)
            AutoJoinStroke.Color = Color3.fromRGB(0, 255, 140)
            AutoJoinButton.Text = "ON"
        else
            AutoJoinButton.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
            AutoJoinStroke.Color = Color3.fromRGB(200, 60, 60)
            AutoJoinButton.Text = "OFF"
        end
    end
    updateAutoJoinVisual()

    AutoJoinButton.MouseButton1Click:Connect(function()
        autoJoinEnabled = not autoJoinEnabled
        updateAutoJoinVisual()
    end)

    -- TAB + DESYNC + DISCORD (b√™n tr√°i)
    local TabBar = Instance.new("Frame")
    TabBar.Size = UDim2.new(0, 100, 1, -98)
    TabBar.Position = UDim2.new(0, 10, 0, 88)
    TabBar.BackgroundColor3 = Color3.fromRGB(18,18,24)
    TabBar.BorderSizePixel = 0
    TabBar.Parent = MainFrame

    local TabCorner = Instance.new("UICorner")
    TabCorner.CornerRadius = UDim.new(0, 8)
    TabCorner.Parent = TabBar

    local TabStroke = Instance.new("UIStroke")
    TabStroke.Thickness = 1
    TabStroke.Color = Color3.fromRGB(50,80,120)
    TabStroke.Transparency = 0.4
    TabStroke.Parent = TabBar

    local tabActiveColor   = Color3.fromRGB(0, 180, 120)
    local tabInactiveColor = Color3.fromRGB(40, 40, 55)

    local BtnLow = Instance.new("TextButton")
    BtnLow.Size = UDim2.new(1, -20, 0, 32)
    BtnLow.Position = UDim2.new(0, 10, 0, 10)
    BtnLow.BackgroundColor3 = tabInactiveColor
    BtnLow.BorderSizePixel = 0
    BtnLow.Text = "10M-"
    BtnLow.Font = Enum.Font.GothamBold
    BtnLow.TextSize = 14
    BtnLow.TextColor3 = Color3.fromRGB(230,230,230)
    BtnLow.Parent = TabBar

    local BtnLowCorner = Instance.new("UICorner")
    BtnLowCorner.CornerRadius = UDim.new(0, 8)
    BtnLowCorner.Parent = BtnLow

    local BtnHigh = Instance.new("TextButton")
    BtnHigh.Size = UDim2.new(1, -20, 0, 32)
    BtnHigh.Position = UDim2.new(0, 10, 0, 52)
    BtnHigh.BackgroundColor3 = tabActiveColor
    BtnHigh.BorderSizePixel = 0
    BtnHigh.Text = "10M+"
    BtnHigh.Font = Enum.Font.GothamBold
    BtnHigh.TextSize = 14
    BtnHigh.TextColor3 = Color3.fromRGB(230,230,230)
    BtnHigh.Parent = TabBar

    local BtnHighCorner = Instance.new("UICorner")
    BtnHighCorner.CornerRadius = UDim.new(0, 8)
    BtnHighCorner.Parent = BtnHigh

    -- N√∫t DESYNC ·ªü d∆∞·ªõi 10M-/10M+
    BtnDesync = Instance.new("TextButton")
    BtnDesync.Size = UDim2.new(1, -20, 0, 28)
    BtnDesync.Position = UDim2.new(0, 10, 0, 94)
    BtnDesync.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
    BtnDesync.BorderSizePixel = 0
    BtnDesync.Text = "OFF Desync"
    BtnDesync.Font = Enum.Font.GothamBold
    BtnDesync.TextSize = 13
    BtnDesync.TextColor3 = Color3.fromRGB(255,255,255)
    BtnDesync.Parent = TabBar

    local BtnDesyncCorner = Instance.new("UICorner")
    BtnDesyncCorner.CornerRadius = UDim.new(0, 8)
    BtnDesyncCorner.Parent = BtnDesync

    local function updateDesyncVisual()
        if desyncToggleOn then
            BtnDesync.Text = "ON Desync"
            BtnDesync.BackgroundColor3 = Color3.fromRGB(255, 140, 40)
        else
            BtnDesync.Text = "OFF Desync"
            BtnDesync.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
        end
    end
    updateDesyncVisual()

    BtnDesync.MouseButton1Click:Connect(function()
        if desyncToggleOn then return end
        desyncToggleOn = true
        updateDesyncVisual()
        triggerDesync()
        task.delay(0.7, function()
            desyncToggleOn = false
            updateDesyncVisual()
        end)
    end)

    -- D√≤ng Discord d∆∞·ªõi n·ªØa
    local DiscordLabel = Instance.new("TextLabel")
    DiscordLabel.Size = UDim2.new(1, -20, 0, 36)
    DiscordLabel.Position = UDim2.new(0, 10, 1, -42)
    DiscordLabel.BackgroundTransparency = 1
    DiscordLabel.Text = "Discord:\ndiscord.gg/hhxrp3qE"
    DiscordLabel.Font = Enum.Font.Gotham
    DiscordLabel.TextSize = 11
    DiscordLabel.TextColor3 = Color3.fromRGB(200,200,210)
    DiscordLabel.TextWrapped = true
    DiscordLabel.TextXAlignment = Enum.TextXAlignment.Left
    DiscordLabel.TextYAlignment = Enum.TextYAlignment.Top
    DiscordLabel.Parent = TabBar

    -- LIST 10M-/10M+
    ScrollingLow = Instance.new("ScrollingFrame")
    ScrollingLow.Size = UDim2.new(1, -130, 1, -98)
    ScrollingLow.Position = UDim2.new(0, 120, 0, 88)
    ScrollingLow.CanvasSize = UDim2.new(0, 0, 0, 0)
    ScrollingLow.ScrollBarThickness = 6
    ScrollingLow.BackgroundColor3 = Color3.fromRGB(12,12,16)
    ScrollingLow.BackgroundTransparency = 0.1
    ScrollingLow.BorderSizePixel = 0
    ScrollingLow.Visible = false
    ScrollingLow.Parent = MainFrame

    local ScrollingLowCorner = Instance.new("UICorner")
    ScrollingLowCorner.CornerRadius = UDim.new(0, 8)
    ScrollingLowCorner.Parent = ScrollingLow

    local LayoutLow = Instance.new("UIListLayout")
    LayoutLow.Padding = UDim.new(0,8)
    LayoutLow.SortOrder = Enum.SortOrder.LayoutOrder
    LayoutLow.Parent = ScrollingLow

    LayoutLow:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        ScrollingLow.CanvasSize = UDim2.new(0, 0, 0, LayoutLow.AbsoluteContentSize.Y + 20)
    end)

    ScrollingHigh = Instance.new("ScrollingFrame")
    ScrollingHigh.Size = UDim2.new(1, -130, 1, -98)
    ScrollingHigh.Position = UDim2.new(0, 120, 0, 88)
    ScrollingHigh.CanvasSize = UDim2.new(0, 0, 0, 0)
    ScrollingHigh.ScrollBarThickness = 6
    ScrollingHigh.BackgroundColor3 = Color3.fromRGB(12,12,16)
    ScrollingHigh.BackgroundTransparency = 0.1
    ScrollingHigh.BorderSizePixel = 0
    ScrollingHigh.Visible = true
    ScrollingHigh.Parent = MainFrame

    local ScrollingHighCorner = Instance.new("UICorner")
    ScrollingHighCorner.CornerRadius = UDim.new(0, 8)
    ScrollingHighCorner.Parent = ScrollingHigh

    local LayoutHigh = Instance.new("UIListLayout")
    LayoutHigh.Padding = UDim.new(0,8)
    LayoutHigh.SortOrder = Enum.SortOrder.LayoutOrder
    LayoutHigh.Parent = ScrollingHigh

    LayoutHigh:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        ScrollingHigh.CanvasSize = UDim2.new(0, 0, 0, LayoutHigh.AbsoluteContentSize.Y + 20)
    end)

    local function setTab(tab)
        currentTab = tab
        if tab == "LOW" then
            BtnLow.BackgroundColor3  = tabActiveColor
            BtnHigh.BackgroundColor3 = tabInactiveColor
            ScrollingLow.Visible      = true
            ScrollingHigh.Visible     = false
        else
            BtnLow.BackgroundColor3  = tabInactiveColor
            BtnHigh.BackgroundColor3 = tabActiveColor
            ScrollingLow.Visible      = false
            ScrollingHigh.Visible     = true
        end
    end

    BtnLow.MouseButton1Click:Connect(function()
        setTab("LOW")
    end)

    BtnHigh.MouseButton1Click:Connect(function()
        setTab("HIGH")
    end)

    UIS.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        if input.KeyCode == Enum.KeyCode.LeftControl then
            MainFrame.Visible = not MainFrame.Visible
            if MainFrame.Visible then
                clearScrolling(ScrollingLow)
                clearScrolling(ScrollingHigh)
            end
        elseif input.KeyCode == Enum.KeyCode.R then
            triggerDesync()
        end
    end)

    LocalPlayer.Chatted:Connect(function(msg)
        if msg:lower() == "/desync" then
            triggerDesync()
        end
    end)
end

createUI()

--========================
-- üì• UI LOOP ‚Äì L·∫§Y LIST PET T·ª™ API
--========================
task.spawn(function()
    warn("[GlobalPetsFinder] UI loop started. USE_API =", USE_API)
    if not USE_API then
        return
    end

    while task.wait(FETCH_INTERVAL) do
        clearScrolling(ScrollingLow)
        clearScrolling(ScrollingHigh)
        autoJoinedJobs = {}

        local farms = apiFetchFarms()
        local seen = {}

        for _, pet in ipairs(farms) do
            local name  = pet.name
            local mps   = pet.mps
            local jobId = pet.jobId

            if not (name and jobId and mps) then
                continue
            end

            local key = name .. "|" .. jobId
            if seen[key] then
                continue
            end
            seen[key] = true

            local bucket = (mps >= TEN_MPS) and "HIGH" or "LOW"

            if bucket == "LOW" then
                AddPetItem(ScrollingLow, name, mps, jobId)
            else
                AddPetItem(ScrollingHigh, name, mps, jobId)
            end

            if autoJoinEnabled and bucket == currentTab and not autoJoinedJobs[jobId] then
                autoJoinedJobs[jobId] = true
                pcall(function()
                    TeleportService:TeleportToPlaceInstance(game.PlaceId, jobId, LocalPlayer)
                end)
            end
        end
    end
end)

--========================
-- üîç SCANNER LOCAL ‚Üí WEBHOOK + API
--========================
if ENABLE_SCANNER then
    local bestMpsPerPet = {}

    local function getMpsFromModel(pet)
        local mpsObj = pet:FindFirstChild("MPS")
        if mpsObj and mpsObj.Value ~= nil then
            local raw = tostring(mpsObj.Value)
            return parseMps(raw), raw
        end

        local bestText = nil
        for _, d in ipairs(pet:GetDescendants()) do
            if d:IsA("TextLabel") or d:IsA("TextButton") then
                local t = d.Text
                if t and t ~= "" then
                    local up = t:upper()
                    if up:find("/S") or up:find("M/S") or up:find("PERSEC") then
                        bestText = t
                        break
                    end
                end
            end
        end

        if bestText then
            return parseMps(bestText), bestText
        end

        return 0, nil
    end

    task.spawn(function()
        warn("[GlobalPetsFinder] Local scanner started.")
        while task.wait(6) do
            local jobId   = tostring(game.JobId or "N/A")
            local placeId = game.PlaceId

            local candidates = {}
            local petsFolder = workspace:FindFirstChild("Pets")

            if petsFolder then
                candidates = petsFolder:GetChildren()
            else
                for _, inst in ipairs(workspace:GetChildren()) do
                    if inst:IsA("Model") or inst:IsA("Folder") then
                        table.insert(candidates, inst)
                    end
                end
            end

            for _, pet in ipairs(candidates) do
                local displayName = detectBrainrotName(pet)
                if not displayName then
                    continue
                end

                local mps = select(1, getMpsFromModel(pet))
                if mps < MIN_MPS then
                    continue
                end

                local prevBest = bestMpsPerPet[pet] or 0
                if mps <= prevBest then
                    continue
                end
                bestMpsPerPet[pet] = mps

                local over50 = (mps > SPLIT_MPS)

                local joinLink = ("https://chillihub1.github.io/chillihub-joiner/?placeId=%s&gameInstanceId=%s")
                    :format(placeId, jobId)

                local title = over50
                    and "üîî **Pet >50M Found! (Brainrot)**"
                    or  "üîî **Pet 1M‚Äì50M Found! (Brainrot)**"

                local content = table.concat({
                    title,
                    "üêæ Name: " .. displayName,
                    "üí∏ MPS: " .. formatMpsShort(mps) .. "/s",
                    "üÜî Job ID: `" .. jobId .. "`",
                    "üåê [JOIN HERE](" .. joinLink .. ")"
                }, "\n")

                if over50 then
                    sendWebhook(WEBHOOK_OVER50, { content = content })
                else
                    sendWebhook(WEBHOOK_HIGH, { content = content })
                    apiAddFarm(displayName, mps, jobId, placeId)
                end
            end
        end
    end)
end

--========================
-- DESYNC STARTUP
--========================
setupSafeFFlags()
print("‚ú® [READY] TanPhu Global Pets Finder + SOFT Desync loaded!")
print("‚ú® B·∫•m R ho·∫∑c /desync ho·∫∑c n√∫t Desync b√™n panel tr√°i.")
